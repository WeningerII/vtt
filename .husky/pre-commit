# Run lint-staged for code quality checks
echo "üé® Running code formatting and linting..."
npx lint-staged

# Determine number of staged JS/TS files once
JS_TS_CHANGED_COUNT=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' | wc -l)

# Run type checking on staged TypeScript files (with incremental builds)
if [ "$JS_TS_CHANGED_COUNT" -gt 0 ]; then
  echo "üîç Running TypeScript checks for staged JS/TS changes..."
  # Increase Node memory to avoid OOM in large monorepo typechecks
  export NODE_OPTIONS="${NODE_OPTIONS:---max-old-space-size=4096}"
  npx tsc --noEmit --incremental
else
  echo "‚ÑπÔ∏è  No staged JS/TS files; skipping TypeScript checks."
fi

# Run related tests only if there are staged JS/TS files, and skip for large changesets
CHANGED_FILES=$JS_TS_CHANGED_COUNT
if [ "$CHANGED_FILES" -gt 0 ] && [ "$CHANGED_FILES" -lt 50 ]; then
  echo "üß™ Running tests for $CHANGED_FILES changed JS/TS files..."
  npx jest --bail --findRelatedTests --passWithNoTests $(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' | tr '\n' ' ')
elif [ "$CHANGED_FILES" -eq 0 ]; then
  echo "‚ÑπÔ∏è  No staged JS/TS files detected; skipping related tests."
else
  echo "‚ö†Ô∏è  Skipping tests due to large changeset ($CHANGED_FILES files). Run 'npm test' manually."
fi

echo "‚úÖ Pre-commit checks completed successfully!"
