# Run lint-staged for code quality checks
echo "üé® Running code formatting and linting..."
npx lint-staged

# Determine number of staged JS/TS files once
JS_TS_CHANGED_COUNT=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' | wc -l)

# Run monorepo-aware type checking using turbo (respects per-package tsconfig)
if [ "$JS_TS_CHANGED_COUNT" -gt 0 ]; then
  echo "üîç Running TypeScript checks across affected packages..."
  export NODE_OPTIONS="${NODE_OPTIONS:---max-old-space-size=4096}"
  if command -v pnpm >/dev/null 2>&1; then
    pnpm typecheck || true
  elif npx --no-install turbo --version >/dev/null 2>&1; then
    npx --no-install turbo run typecheck || true
  else
    echo "‚ÑπÔ∏è  pnpm/turbo unavailable in environment; skipping automated typecheck."
  fi
else
  echo "‚ÑπÔ∏è  No staged JS/TS files; skipping TypeScript checks."
fi

# Run related tests only if there are staged JS/TS files, and skip for large changesets
CHANGED_FILES=$JS_TS_CHANGED_COUNT
if [ "$CHANGED_FILES" -gt 0 ] && [ "$CHANGED_FILES" -lt 50 ]; then
  echo "üß™ Running tests for $CHANGED_FILES changed JS/TS files..."
  if npx --no-install jest --version >/dev/null 2>&1; then
    npx jest --bail --findRelatedTests --passWithNoTests $(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' | tr '\n' ' ') || echo "‚ö†Ô∏è  Jest related-tests failed or errored; continuing commit."
  else
    echo "‚ÑπÔ∏è  Jest not available in this repo; skipping related tests."
  fi
elif [ "$CHANGED_FILES" -eq 0 ]; then
  echo "‚ÑπÔ∏è  No staged JS/TS files detected; skipping related tests."
else
  echo "‚ö†Ô∏è  Skipping tests due to large changeset ($CHANGED_FILES files). Run 'npm test' manually."
fi

echo "‚úÖ Pre-commit checks completed successfully!"
