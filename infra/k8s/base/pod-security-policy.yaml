apiVersion: v1
kind: Namespace
metadata:
  name: vtt
  labels:
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
    security.hardened: "true"
---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: vtt-security-baseline
  annotations:
    policies.kyverno.io/title: VTT Security Baseline
    policies.kyverno.io/category: Security
    policies.kyverno.io/severity: high
    policies.kyverno.io/description: >-
      Enforces security baseline for VTT workloads including image scanning,
      resource limits, and security contexts.
spec:
  validationFailureAction: enforce
  background: true
  rules:
    - name: require-non-root-user
      match:
        any:
        - resources:
            kinds:
            - Pod
            namespaces:
            - vtt
      validate:
        message: "Containers must run as non-root user"
        pattern:
          spec:
            securityContext:
              runAsNonRoot: true
            containers:
            - name: "*"
              securityContext:
                runAsNonRoot: true
                allowPrivilegeEscalation: false
                capabilities:
                  drop: ["ALL"]
                readOnlyRootFilesystem: true
    
    - name: require-resource-limits
      match:
        any:
        - resources:
            kinds:
            - Pod
            namespaces:
            - vtt
      validate:
        message: "All containers must have CPU and memory limits"
        pattern:
          spec:
            containers:
            - name: "*"
              resources:
                limits:
                  cpu: "?*"
                  memory: "?*"
                requests:
                  cpu: "?*"
                  memory: "?*"
    
    - name: disallow-privileged-containers
      match:
        any:
        - resources:
            kinds:
            - Pod
            namespaces:
            - vtt
      validate:
        message: "Privileged containers are not allowed"
        pattern:
          spec:
            containers:
            - name: "*"
              securityContext:
                privileged: "false"
    
    - name: require-image-signature-verification
      match:
        any:
        - resources:
            kinds:
            - Pod
            namespaces:
            - vtt
      validate:
        message: "Container images must be from trusted registries"
        pattern:
          spec:
            containers:
            - name: "*"
              image: "ghcr.io/YOUR_ORG/*"
