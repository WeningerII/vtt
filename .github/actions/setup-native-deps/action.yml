name: "Setup Native Dependencies"
description: "Install native build dependencies required for Node.js native modules"
inputs:
  extra-packages:
    description: "Additional packages to install"
    required: false
    default: ""
runs:
  using: "composite"
  steps:
    - name: Cache apt packages
      if: runner.os == 'Linux'
      uses: actions/cache@v4
      with:
        path: /var/cache/apt
        key: apt-cache-${{ runner.os }}-${{ hashFiles('**/package*.json') }}
        restore-keys: |
          apt-cache-${{ runner.os }}-

    - name: Install native build dependencies
      if: runner.os == 'Linux'
      shell: bash
      run: |
        set -euo pipefail
        echo "Installing native build dependencies..."
        sudo apt-get update

        # Core build tools
        PACKAGES="nasm yasm build-essential libpng-dev"

        # Add extra packages if provided
        if [ -n "${{ inputs.extra-packages }}" ]; then
          PACKAGES="$PACKAGES ${{ inputs.extra-packages }}"
        fi

        echo "Installing: $PACKAGES"
        sudo apt-get install -y $PACKAGES

        echo "âœ… Native dependencies installed successfully"

    - name: Skip native dependency setup on non-Linux runners
      if: runner.os != 'Linux'
      shell: bash
      run: |
        echo "Native dependency setup is only required on Linux runners. Skipping."
